name: binaries
on:
  push: {}
  schedule:
    - cron:  '0 0 * * 0'  # run each Sunday

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  JOBS: 3
  CFLAGS: -Os -fomit-frame-pointer -pipe
  LINUX_LDFLAGS: -static -Wl,--as-needed
  # List of extra nginx modules to download.
  NGINX_MODULES: >-
    nginx/njs
    vision5/ngx_devel_kit
    openresty/echo-nginx-module
    openresty/headers-more-nginx-module
    openresty/set-misc-nginx-module

jobs:
  njs-x86_64-linux:
    name: njs-${{ matrix.NJS_VERSION }}${{ matrix.VARIANT }}-x86_64-linux
    runs-on: ubuntu-latest
    container:
      image: docker://alpine:3.12
    strategy:
      matrix:
        NJS_VERSION:
          - 0.5.0
        VARIANT:
          - '-debug'
          - ''
    steps:
      - name: Checkout njs repository
        uses: actions/checkout@v2
        with:
          repository: nginx/njs
          ref: ${{ matrix.NJS_VERSION }}

      - name: Checkout master branch
        uses: actions/checkout@v2
        with:
          path: master

      - name: Install dependencies
        run: apk add -U build-base libedit-dev libedit-static pcre-dev ncurses-dev ncurses-static

      - name: Build njs
        env:
          NJS_VERSION: ${{ matrix.NJS_VERSION }}
          VARIANT: ${{ matrix.VARIANT }}
          CFLAGS: ${{ env.CFLAGS }}
          LDFLAGS: ${{ env.LINUX_LDFLAGS }}
        run: ./master/scripts/build-njs

      - name: Upload njs binary to artifacts
        uses: actions/upload-artifact@v2
        with:
          path: artifact/*

  njs-multi-linux:
    name: njs-${{ matrix.NJS_VERSION }}${{ matrix.VARIANT }}-${{ matrix.ARCH }}-linux
    runs-on: ubuntu-latest
    strategy:
      matrix:
        NJS_VERSION:
          - 0.5.0
        VARIANT:
          - '-debug'
          - ''
        ARCH:
          - aarch64
          - armv7
          - ppc64le
    steps:
      - name: Checkout njs repository
        uses: actions/checkout@v2
        with:
          repository: nginx/njs
          ref: ${{ matrix.NJS_VERSION }}

      - name: Checkout master branch
        uses: actions/checkout@v2
        with:
          path: master

      - name: Download alpine-chroot-install
        run: |
          wget https://raw.githubusercontent.com/alpinelinux/alpine-chroot-install/v0.12.1/alpine-chroot-install
          echo '5571ad4d17d14bb09ad23a75060f05553786e564  alpine-chroot-install' | sha1sum -c
          chmod +x alpine-chroot-install

      - name: Install latest Alpine for ${{ matrix.ARCH }}
        run: |
          sudo ./alpine-chroot-install \
            -a ${{ matrix.ARCH }} \
            -k 'VARIANT [A-Z_]*_VERSION CFLAGS LDFLAGS JOBS' \
            -p 'build-base libedit-dev libedit-static pcre-dev ncurses-dev ncurses-static'
          /alpine/enter-chroot uname -a

      - name: Build njs
        env:
          NJS_VERSION: ${{ matrix.NJS_VERSION }}
          VARIANT: ${{ matrix.VARIANT }}
          CFLAGS: ${{ env.CFLAGS }}
          LDFLAGS: ${{ env.LINUX_LDFLAGS }}
        run: |
          /alpine/enter-chroot -u $USER ./master/scripts/build-njs

      - name: Upload njs binary to artifacts
        uses: actions/upload-artifact@v2
        with:
          path: artifact/*

  njs-x86_64-darwin:
    name: njs-${{ matrix.NJS_VERSION }}${{ matrix.VARIANT }}-x86_64-darwin
    runs-on: macos-latest
    strategy:
      matrix:
        NJS_VERSION:
          - 0.5.0
        VARIANT:
          - '-debug'
          - ''
    steps:
      - name: Checkout njs repository
        uses: actions/checkout@v2
        with:
          repository: nginx/njs
          ref: ${{ matrix.NJS_VERSION }}

      - name: Checkout master branch
        uses: actions/checkout@v2
        with:
          path: master

      - name: Install dependencies
        run: brew install libedit ncurses pcre

      # cmake prefers dynamic libs and there's no option to change it, so
      # we have to remove them to give it no other option than using static.
      - name: Remove dylibs
        run: |
          rm /usr/local/opt/libedit/lib/*.dylib
          rm /usr/local/opt/ncurses/lib/*.dylib
          rm /usr/local/opt/pcre/lib/*.dylib

      - name: Build njs
        env:
          NJS_VERSION: ${{ matrix.NJS_VERSION }}
          VARIANT: ${{ matrix.VARIANT }}
          CFLAGS: ${{ env.CFLAGS }} -I/usr/local/opt/libedit/include -I/usr/local/opt/ncurses/include -I/usr/local/opt/pcre/include
          LDFLAGS: -L/usr/local/opt/libedit/lib -L/usr/local/opt/ncurses/lib -L/usr/local/opt/pcre/lib
        run: ./master/scripts/build-njs

      - name: Upload njs binary to artifacts
        uses: actions/upload-artifact@v2
        with:
          path: artifact/*

  nginx-x86_64-linux:
    name: nginx-${{ matrix.NGINX_VERSION }}-x86_64-linux
    runs-on: ubuntu-latest
    container:
      image: docker://alpine:3.12
    strategy:
      matrix:
        NGINX_VERSION:
          - 1.18.0
          - 1.19.5
    steps:
      - name: Checkout nginx repository
        uses: actions/checkout@v2
        with:
          repository: nginx/nginx
          ref: release-${{ matrix.NGINX_VERSION }}

      - name: Checkout master branch
        uses: actions/checkout@v2
        with:
          path: master

      - name: Install dependencies
        run: apk add -U build-base curl jq linux-headers openssl-dev openssl-libs-static pcre-dev zlib-dev zlib-static

      - name: Download and extract nginx modules
        # This will define <NAME>_DIR and <NAME>_VERSION env. variables for each module.
        run: ./master/scripts/fetch-sources $NGINX_MODULES >> $GITHUB_ENV

      - name: Build nginx
        env:
          NGINX_VERSION: ${{ matrix.NGINX_VERSION }}
          CFLAGS: ${{ env.CFLAGS }}
          LDFLAGS: ${{ env.LINUX_LDFLAGS }}
        run: ./master/scripts/build-nginx

      - name: Upload nginx binary to artifacts
        uses: actions/upload-artifact@v2
        with:
          path: artifact/*

  nginx-multi-linux:
    name: nginx-${{ matrix.NGINX_VERSION }}-${{ matrix.ARCH }}-linux
    runs-on: ubuntu-latest
    strategy:
      matrix:
        NGINX_VERSION:
          - 1.18.0
          - 1.19.5
        ARCH:
          - aarch64
          - armv7
          #- ppc64le  # it works but takes twice as long as the others
    steps:
      - name: Checkout nginx repository
        uses: actions/checkout@v2
        with:
          repository: nginx/nginx
          ref: release-${{ matrix.NGINX_VERSION }}

      - name: Checkout master branch
        uses: actions/checkout@v2
        with:
          path: master

      - name: Download and extract nginx modules
        # This will define <NAME>_DIR and <NAME>_VERSION env. variables for each module.
        run: ./master/scripts/fetch-sources $NGINX_MODULES >> $GITHUB_ENV

      - name: Download alpine-chroot-install
        run: |
          wget https://raw.githubusercontent.com/alpinelinux/alpine-chroot-install/v0.12.1/alpine-chroot-install
          echo '5571ad4d17d14bb09ad23a75060f05553786e564  alpine-chroot-install' | sha1sum -c
          chmod +x alpine-chroot-install

      - name: Install latest Alpine for ${{ matrix.ARCH }}
        run: |
          sudo ./alpine-chroot-install \
            -a ${{ matrix.ARCH }} \
            -k 'VARIANT [A-Z_]*_DIR [A-Z_]*_VERSION CFLAGS LDFLAGS JOBS' \
            -p 'build-base linux-headers openssl-dev openssl-libs-static pcre-dev zlib-dev zlib-static'
          /alpine/enter-chroot uname -a

      - name: Build nginx
        env:
          NGINX_VERSION: ${{ matrix.NGINX_VERSION }}
          VARIANT: ${{ matrix.VARIANT }}
          CFLAGS: ${{ env.CFLAGS }}
          LDFLAGS: ${{ env.LINUX_LDFLAGS }}
        run: |
          /alpine/enter-chroot -u $USER ./master/scripts/build-nginx

      - name: Upload nginx binary to artifacts
        uses: actions/upload-artifact@v2
        with:
          path: artifact/*

  nginx-x86_64-darwin:
    name: nginx-${{ matrix.NGINX_VERSION }}-x86_64-darwin
    runs-on: macos-latest
    strategy:
      matrix:
        NGINX_VERSION:
          - 1.18.0
          - 1.19.5
    steps:
      - name: Checkout nginx repository
        uses: actions/checkout@v2
        with:
          repository: nginx/nginx
          ref: release-${{ matrix.NGINX_VERSION }}

      - name: Checkout master branch
        uses: actions/checkout@v2
        with:
          path: master

      - name: Install dependencies
        run: brew install jq openssl@1.1 pcre zlib

      - name: Download and extract nginx modules
        # This will define <NAME>_DIR and <NAME>_VERSION env. variables for each module.
        run: ./master/scripts/fetch-sources $NGINX_MODULES >> $GITHUB_ENV

      # cmake prefers dynamic libs and there's no option to change it, so
      # we have to remove them to give it no other option than using static.
      - name: Remove dylibs
        run: |
          rm /usr/local/opt/openssl/lib/*.dylib
          rm /usr/local/opt/pcre/lib/*.dylib
          rm /usr/local/opt/zlib/lib/*.dylib

      - name: Build nginx
        env:
          NGINX_VERSION: ${{ matrix.NGINX_VERSION }}
          CFLAGS: ${{ env.CFLAGS }} -I/usr/local/opt/openssl/include -I/usr/local/opt/pcre/include -I/usr/local/opt/zlib/include
          LDFLAGS: -L/usr/local/opt/openssl/lib -L/usr/local/opt/pcre/lib -L/usr/local/opt/zlib/lib
        run: ./master/scripts/build-nginx

      - name: Upload nginx binary to artifacts
        uses: actions/upload-artifact@v2
        with:
          path: artifact/*

  nginx-x86_64-win32:
    name: nginx-${{ matrix.NGINX_VERSION }}-x86_64-win32
    runs-on: windows-latest
    strategy:
      matrix:
        NGINX_VERSION:
          - 1.18.0
          - 1.19.5
    steps:
      - name: Checkout nginx repository
        uses: actions/checkout@v2
        with:
          repository: nginx/nginx
          ref: release-${{ matrix.NGINX_VERSION }}

      - name: Checkout myfreeer/nginx-build-msys2
        uses: actions/checkout@v2
        with:
          repository: myfreeer/nginx-build-msys2
          ref: ${{ matrix.NGINX_VERSION }}
          path: msys2

      - name: Checkout master branch
        uses: actions/checkout@v2
        with:
          path: master

      - name: Setup MSYS2 and install packages
        uses: msys2/setup-msys2@v2
        with:
          update: false
          install: base-devel mingw-w64-x86_64-toolchain mingw-w64-x86_64-jq

      - name: Download and extract libraries
        shell: msys2 {0}
        # This will define <NAME>_DIR and <NAME>_VERSION env. variables for each library.
        run: ./master/scripts/fetch-sources openssl pcre zlib >> $GITHUB_ENV

      - name: Download and extract nginx modules
        shell: msys2 {0}
        # This will define <NAME>_DIR and <NAME>_VERSION env. variables for each module.
        run: ./master/scripts/fetch-sources $NGINX_MODULES >> $GITHUB_ENV

      - name: Apply patches
        shell: msys2 {0}
        run: |
          for i in msys2/nginx-*.patch; do
            patch -p1 < $i
          done

      - name: Build nginx
        shell: msys2 {0}
        env:
          NGINX_VERSION: ${{ matrix.NGINX_VERSION }}
          # -DFD_SETSIZE=1024 is per official nginx win32 binary.
          CFLAGS: ${{ env.CFLAGS }} -DFD_SETSIZE=1024
        run: ./master/scripts/build-nginx

      - name: Upload nginx binary to artifacts
        uses: actions/upload-artifact@v2
        with:
          path: artifact/*

  upload:
    name: Upload binaries
    needs:
      - njs-x86_64-linux
      - njs-multi-linux
      - njs-x86_64-darwin
      - nginx-x86_64-linux
      - nginx-multi-linux
      - nginx-x86_64-darwin
      - nginx-x86_64-win32
    if: github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    container:
      image: docker://alpine:3.12
    steps:
      - name: Install dependencies
        run: apk add -U git nodejs tree

      - name: Checkout master branch
        uses: actions/checkout@v2
        with:
          path: master

      - name: Checkout binaries branch
        uses: actions/checkout@v2
        with:
          ref: binaries
          path: binaries

      - name: Download and unpack all workflow run artifacts
        uses: actions/download-artifact@v2

      - name: Move downloaded binaries into repository
        run: |
          mv artifact/* binaries/
          ls -lah binaries/

      - name: Generate index.json
        run: ./master/scripts/generate-index --json binaries/ binaries/index.json

      - name: Generate index.csv
        run: ./master/scripts/generate-index --csv binaries/ binaries/index.csv

      - name: Generate index.html
        working-directory: binaries
        run: tree -hv -H . -o index.html .

      - name: Check if there are any changes
        id: has_changes
        working-directory: binaries
        run: |
          git status || exit 1
          test -n "$(git status --porcelain)" && result=yes || result=no
          echo ::set-output name=result::$result

      - name: Commit changes
        if: steps.has_changes.outputs.result == 'yes'
        working-directory: binaries
        run: |
          git config --local user.email "github-actions@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add --all
          git commit -m "Built from ${{ github.sha }}"

      - name: Push changes back to origin
        if: steps.has_changes.outputs.result == 'yes'
        working-directory: binaries
        run: git push https://${GITHUB_ACTOR}:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git binaries
